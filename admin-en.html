<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Recycling Credits</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2em auto; padding: 1em; border: 1px solid #ccc; border-radius: 8px; }
        button { font-size: 1em; padding: 0.5em 1em; cursor: pointer; border-radius: 4px; border: 1px solid #007bff; background-color: #007bff; color: white; margin-top: 10px; }
        button:disabled { background-color: #ccc; border-color: #ccc; cursor: not-allowed; }
        input { font-size: 1em; padding: 0.5em; width: 95%; margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        #status { margin-top: 1em; padding: 0.5em; background-color: #f0f0f0; border-radius: 4px; word-break: break-all; }
        .section { margin-top: 1.5em; padding-top: 1em; border-top: 1px solid #eee; }
        .error-message { color: #d9534f; }
        .success-message { color: #5cb85c; }
    </style>
</head>
<body>
    <h1>Admin Panel - Recycling Credits</h1>
    <p>Use this page to manage the contract and certify new credits.</p>
    
    <button id="connectButton">Connect as Administrator</button>
    <hr>

    <div id="certifierPanel" class="section" style="display:none;">
        <h2>Certify and Mint New Credit</h2>
        <form id="mintForm">
            <div>
                <label for="ownerAddress">Beneficiary Address (Cooperative):</label>
                <input type="text" id="ownerAddress" required placeholder="0x...">
            </div>
            <div>
                <label for="materialType">Material Type:</label>
                <input type="text" id="materialType" required placeholder="E.g., PET Plastic">
            </div>
            <div>
                <label for="weightKg">Weight (in Kg):</label>
                <input type="number" id="weightKg" required placeholder="E.g., 1000">
            </div>
            <div>
                <label for="location">Location (Origin):</label>
                <input type="text" id="location" required placeholder="E.g., Recycle-All Coop, SP">
            </div>
            <div>
                <label for="proofHash">Proof Hash (Invoice):</label>
                <input type="text" id="proofHash" required placeholder="0x...">
            </div>
            <button type="submit" id="mintButton">Mint Credit</button>
        </form>
    </div>

    <div id="adminRolePanel" class="section" style="display:none;">
        <h2>Manage Certifier Role</h2>
        <p>Add or remove addresses that can certify and mint new credits.</p>
        <div>
            <label for="accountAddress">Wallet Address:</label>
            <input type="text" id="accountAddress" placeholder="0x...">
        </div>
        <button id="grantRoleButton">Grant Role</button>
        <button id="revokeRoleButton" style="background-color:#d9534f; border-color:#d9534f;">Revoke Role</button>
    </div>

    <div id="accessDenied" style="display:none;">
        <h2 class="error-message">Access Denied</h2>
        <p>The connected wallet does not have ADMIN or CERTIFIER permissions.</p>
    </div>

    <div id="status">Please connect your wallet to continue...</div>

    <script>
        // The JavaScript logic is identical to the Portuguese version.
        const connectButton = document.getElementById('connectButton');
        const statusDiv = document.getElementById('status');
        const certifierPanel = document.getElementById('certifierPanel');
        const adminRolePanel = document.getElementById('adminRolePanel');
        const accessDenied = document.getElementById('accessDenied');
        const mintForm = document.getElementById('mintForm');
        const mintButton = document.getElementById('mintButton');
        const ownerAddressInput = document.getElementById('ownerAddress');
        const materialTypeInput = document.getElementById('materialType');
        const weightKgInput = document.getElementById('weightKg');
        const locationInput = document.getElementById('location');
        const proofHashInput = document.getElementById('proofHash');
        const accountAddressInput = document.getElementById('accountAddress');
        const grantRoleButton = document.getElementById('grantRoleButton');
        const revokeRoleButton = document.getElementById('revokeRoleButton');
        const contractAddress = "0xe18e887380bD90BCEa276747DaD314DfB06c1f4f";
        const contractABI = [ "function certifyAndMint(address owner, string memory materialType, uint256 weightKg, string memory location, bytes32 proofHash)", "function grantRole(bytes32 role, address account)", "function revokeRole(bytes32 role, address account)", "function hasRole(bytes32 role, address account) view returns (bool)", "function CERTIFIER_ROLE() view returns (bytes32)" ];
        const DEFAULT_ADMIN_ROLE = "0x0000000000000000000000000000000000000000000000000000000000000000";
        let provider, signer, contract;

        connectButton.addEventListener('click', async () => {
            if (typeof window.ethereum === 'undefined') {
                statusDiv.textContent = "MetaMask not found!";
                return;
            }
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                const userAddress = await signer.getAddress();
                const certifierRole = await contract.CERTIFIER_ROLE();
                const isAdmin = await contract.hasRole(DEFAULT_ADMIN_ROLE, userAddress);
                const isCertifier = await contract.hasRole(certifierRole, userAddress);

                connectButton.style.display = 'none';

                if (isAdmin || isCertifier) {
                    statusDiv.textContent = `Connected as: ${userAddress.substring(0, 6)}... | Roles: ${isAdmin ? 'ADMIN' : ''} ${isCertifier ? 'CERTIFIER' : ''}`;
                    if (isCertifier) certifierPanel.style.display = 'block';
                    if (isAdmin) adminRolePanel.style.display = 'block';
                } else {
                    statusDiv.textContent = `Connected wallet has no permissions: ${userAddress.substring(0, 6)}...`;
                    accessDenied.style.display = 'block';
                }
            } catch (error) {
                statusDiv.textContent = `Error connecting: ${error.message}`;
            }
        });

        mintForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            try {
                mintButton.disabled = true;
                statusDiv.innerHTML = `<span class="success-message">Sending transaction... Please confirm in your wallet.</span>`;
                const tx = await contract.certifyAndMint( ownerAddressInput.value, materialTypeInput.value, weightKgInput.value, locationInput.value, proofHashInput.value );
                statusDiv.textContent = `Transaction sent! Awaiting mining... Hash: ${tx.hash}`;
                await tx.wait();
                statusDiv.innerHTML = `<span class="success-message">Success! Credit minted successfully!</span>`;
                mintButton.disabled = false;
                mintForm.reset();
            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `<span class="error-message">Error minting: ${error.reason || error.message}</span>`;
                mintButton.disabled = false;
            }
        });

        async function handleRoleChange(action) {
            const account = accountAddressInput.value;
            if (!ethers.utils.isAddress(account)) {
                statusDiv.innerHTML = `<span class="error-message">Invalid address.</span>`;
                return;
            }
            const buttonToDisable = action === 'grant' ? grantRoleButton : revokeRoleButton;
            const actionText = action === 'grant' ? 'granting' : 'revoking';
            try {
                buttonToDisable.disabled = true;
                statusDiv.innerHTML = `<span class="success-message">Awaiting confirmation for ${actionText} the role...</span>`;
                const certifierRole = await contract.CERTIFIER_ROLE();
                const tx = action === 'grant' ? await contract.grantRole(certifierRole, account) : await contract.revokeRole(certifierRole, account);
                statusDiv.textContent = `Transaction sent! Awaiting mining... Hash: ${tx.hash}`;
                await tx.wait();
                statusDiv.innerHTML = `<span class="success-message">Success! CERTIFIER role was ${action === 'grant' ? 'granted to' : 'revoked from'} ${account.substring(0, 6)}...</span>`;
                buttonToDisable.disabled = false;
            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `<span class="error-message">Error while ${actionText}: ${error.reason || error.message}</span>`;
                buttonToDisable.disabled = false;
            }
        }

        grantRoleButton.addEventListener('click', () => handleRoleChange('grant'));
        revokeRoleButton.addEventListener('click', () => handleRoleChange('revoke'));
    </script>
</body>
</html>
