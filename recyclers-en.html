<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recyclers Portal - Generate Credit Proof</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2em auto; padding: 1em; border: 1px solid #ccc; border-radius: 8px; }
        button { font-size: 1em; padding: 0.5em 1em; cursor: pointer; border-radius: 4px; border: 1px solid #28a745; background-color: #28a745; color: white; margin-top: 10px; }
        input, textarea { font-size: 1em; padding: 0.5em; width: 95%; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        #outputSection { margin-top: 1.5em; padding: 1em; border: 1px solid #28a745; border-radius: 8px; background-color: #f8f9fa; }
        #hashOutput { font-family: monospace; background-color: #e9ecef; padding: 0.5em; word-break: break-all; border-radius: 4px; }
        .section { margin-top: 1.5em; padding-top: 1em; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <h1>Recyclers / Originator Portal</h1>
    <p>Use this tool to generate the data and proof hash to send to your certifier (e.g., E-co.lab).</p>
    
    <div class="section">
        <h2>Register Recycling Batch</h2>
        <form id="proofForm">
            <div>
                <label for="materialType">Material Type:</label>
                <input type="text" id="materialType" required placeholder="E.g., Baled PET Plastic">
            </div>
            <div>
                <label for="weightKg">Weight (in Kg):</label>
                <input type="number" id="weightKg" required placeholder="E.g., 1500">
            </div>
            <div>
                <label for="location">Your Location (Recycler/City):</label>
                <input type="text" id="location" required placeholder="E.g., Recycle-All Coop, SP">
            </div>
            <div>
                <label for="proofDocument">Proof Data (Paste Invoice No. or relevant data here):</label>
                <textarea id="proofDocument" rows="4" required placeholder="E.g., Invoice No. 987654, issued on 08/01/2024 to Recycler XYZ..."></textarea>
            </div>
            <button type="submit" id="generateButton">Generate Hash and Data for Certification</button>
        </form>
    </div>

    <div id="outputSection" style="display:none;">
        <h2>Data Ready to Submit</h2>
        <p><strong>Copy the data below and send it to your certifier.</strong> With this information, they will be able to mint your recycling credit on the blockchain.</p>
        <ul>
            <li><strong>Beneficiary (your wallet address):</strong> <span id="beneficiaryOutput"></span></li>
            <li><strong>Material Type:</strong> <span id="materialOutput"></span></li>
            <li><strong>Weight (Kg):</strong> <span id="weightOutput"></span></li>
            <li><strong>Location:</strong> <span id="locationOutput"></span></li>
        </ul>
        <p><strong>Proof Hash:</strong></p>
        <p id="hashOutput"></p>
    </div>

    <script>
        const proofForm = document.getElementById('proofForm');
        const generateButton = document.getElementById('generateButton');
        const outputSection = document.getElementById('outputSection');

        // Inputs
        const materialTypeInput = document.getElementById('materialType');
        const weightKgInput = document.getElementById('weightKg');
        const locationInput = document.getElementById('location');
        const proofDocumentInput = document.getElementById('proofDocument');

        // Outputs
        const beneficiaryOutput = document.getElementById('beneficiaryOutput');
        const materialOutput = document.getElementById('materialOutput');
        const weightOutput = document.getElementById('weightOutput');
        const locationOutput = document.getElementById('locationOutput');
        const hashOutput = document.getElementById('hashOutput');

        proofForm.addEventListener('submit', async (event) => {
            // Prevents the default page reload
            event.preventDefault(); 

            // The recyclers needs to connect a wallet to set the beneficiary
            if (typeof window.ethereum === 'undefined') {
                alert("Please install MetaMask to use this tool.");
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const beneficiaryAddress = accounts[0];

                const material = materialTypeInput.value;
                const weight = weightKgInput.value;
                const location = locationInput.value;
                const proofText = proofDocumentInput.value;

                // To ensure a unique hash, we concatenate the most important data + a timestamp
                const dataToHash = `${beneficiaryAddress}-${material}-${weight}-${location}-${proofText}-${Date.now()}`;
                
                // Converts the string to bytes and calculates the Keccak256 hash
                const proofHash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(dataToHash));

                // Display the results
                beneficiaryOutput.textContent = beneficiaryAddress;
                materialOutput.textContent = material;
                weightOutput.textContent = weight;
                locationOutput.textContent = location;
                hashOutput.textContent = proofHash;

                outputSection.style.display = 'block';

            } catch (error) {
                console.error("Error:", error);
                alert(`An error occurred: ${error.message}`);
            }
        });
    </script>
</body>
</html>
